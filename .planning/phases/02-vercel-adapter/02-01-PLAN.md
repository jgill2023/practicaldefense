---
phase: 02-vercel-adapter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/app.ts
  - server/index.ts
  - api/index.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "createApp() in server/app.ts returns a configured Express app with all routes and middleware registered"
    - "api/index.ts exports a default handler that Vercel can invoke as a serverless function"
    - "server/index.ts imports createApp() from server/app.ts, adds Vite/static serving, and starts HTTP listener"
    - "npm run dev still starts the local development server successfully"
    - "express.raw() is registered on /api/online-course/webhook (the actual Stripe webhook path), not /api/webhooks/stripe"
    - "process.exit(1) startup validation exists ONLY in server/index.ts, NOT in server/app.ts"
    - "cronService.initialize() exists ONLY in server/index.ts, NOT in server/app.ts or api/index.ts"
    - "setupVite and serveStatic are NOT imported by server/app.ts"
  artifacts:
    - path: "server/app.ts"
      provides: "Express app factory function"
      exports: ["createApp"]
    - path: "api/index.ts"
      provides: "Vercel serverless entry point"
      exports: ["default"]
    - path: "server/index.ts"
      provides: "Local dev entry point (imports createApp, adds Vite, listen)"
    - path: "package.json"
      provides: "Updated build script (vite build only, no esbuild for Vercel)"
  key_links:
    - from: "api/index.ts"
      to: "server/app.ts"
      via: "import { createApp } from '../server/app'"
      pattern: "createApp"
    - from: "server/index.ts"
      to: "server/app.ts"
      via: "import { createApp } from './app'"
      pattern: "createApp"
    - from: "server/app.ts"
      to: "server/routes.ts"
      via: "registerRoutes(app)"
      pattern: "registerRoutes"
---

<objective>
Extract the Express app setup from server/index.ts into a new server/app.ts factory function, create api/index.ts as the Vercel serverless entry point, and fix the Stripe webhook raw body path.

Purpose: Vercel cannot call server.listen() — it invokes the exported handler directly. The Express app must be separable from the HTTP listener and cron initialization. This plan creates the clean separation needed for both Vercel serverless deployment AND continued local development.

Output: server/app.ts (Express factory), api/index.ts (Vercel entry), refactored server/index.ts (local dev only), updated package.json build script.
</objective>

<execution_context>
@/Users/jeremygill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremygill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vercel-adapter/02-RESEARCH.md
@server/index.ts
@server/routes.ts (first 50 lines — registerRoutes signature, imports)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server/app.ts and refactor server/index.ts</name>
  <files>server/app.ts, server/index.ts</files>
  <action>
Create `server/app.ts` with an async `createApp()` function that contains ALL the Express app setup currently in `server/index.ts`:

1. Create `server/app.ts`:
   - Import express, registerRoutes, createSeoMiddleware, db, instructorGoogleCredentials, eq
   - Export `async function createApp()` that:
     a. Creates `const app = express()`
     b. Registers `express.raw({ type: 'application/json' })` on `/api/online-course/webhook` — NOT `/api/webhooks/stripe` (fixing the pre-existing bug from research finding #4). This MUST come BEFORE `express.json()`.
     c. Registers `express.json()` and `express.urlencoded({ extended: false })`
     d. Registers the request logging middleware (the res.on("finish") logger from lines 36-64 of current server/index.ts). Import the `log` function from `./vite` — only the `log` function, NOT `setupVite` or `serveStatic`.
     e. Calls `await registerRoutes(app)` — note: registerRoutes returns a `Server` (http.createServer) which we do NOT need in app.ts. The function must still be called to register all routes. Capture but discard the return: `await registerRoutes(app);`
     f. Registers the error handler middleware (lines 69-75 of current server/index.ts). IMPORTANT: The current error handler does `throw err` after sending the response — keep this behavior as-is.
     g. Registers `app.use(createSeoMiddleware())`
     h. Registers the Google OAuth callback route `app.get("/auth/callback", ...)` with the full handler from lines 82-127
     i. Returns `app`
   - Do NOT include: `process.exit(1)` startup validation, `cronService` import/initialization, `setupVite`/`serveStatic` import/usage, `server.listen()`, http `createServer`

2. Refactor `server/index.ts`:
   - Remove ALL the code that moved to `server/app.ts` (express setup, middleware, routes, error handler, SEO, OAuth callback)
   - Keep: the REQUIRED_ENV_VARS validation block (lines 13-27) with `process.exit(1)`
   - Keep: cronService import and initialization
   - Keep: setupVite and serveStatic imports from "./vite"
   - Add: `import { createApp } from './app'`
   - Restructure the async IIFE to:
     a. Call `const app = await createApp()`
     b. Set up Vite dev server or static serving (if dev: `await setupVite(app, server)`, else: `serveStatic(app)`) — note: `setupVite` needs a `Server` object. Create it with `const server = createServer(app)` using `import { createServer } from "http"`.
     c. Call `server.listen(...)` with existing port logic
     d. Call `cronService.initialize()` in the listen callback
   - Remove old imports that are no longer directly used (express, registerRoutes, createSeoMiddleware, db, instructorGoogleCredentials, eq, etc.)

Key constraint: `registerRoutes(app)` in routes.ts calls `createServer(app)` and returns the Server. But `server/app.ts` only needs the app — NOT the Server. The `server/index.ts` still needs a Server for `setupVite` and `listen`. So `server/index.ts` must create its own Server: `const server = createServer(app)` after getting the app from `createApp()`. The http Server created inside `registerRoutes` is discarded — this is fine because `createServer(app)` wraps the same Express app.
  </action>
  <verify>
    1. Run `npx tsc --noEmit 2>&1 | head -5` — verify no NEW TypeScript errors are introduced (pre-existing ~646 errors are expected; look for errors in server/app.ts, server/index.ts, api/index.ts specifically)
    2. Verify server/app.ts does NOT contain: `process.exit`, `cronService`, `setupVite`, `serveStatic`, `server.listen`
    3. Verify server/app.ts DOES contain: `express.raw` on `/api/online-course/webhook`, `createSeoMiddleware`, `registerRoutes`, the Google OAuth callback
    4. Verify server/index.ts DOES contain: `process.exit(1)`, `cronService.initialize()`, `createApp`, `setupVite`/`serveStatic`, `server.listen`
  </verify>
  <done>server/app.ts exports createApp() that returns a fully-configured Express app. server/index.ts imports createApp(), wraps it with HTTP server, Vite, cron, and listen. No process.exit in app.ts. No cronService in app.ts. Stripe raw body middleware on /api/online-course/webhook.</done>
</task>

<task type="auto">
  <name>Task 2: Create api/index.ts and update package.json build script</name>
  <files>api/index.ts, package.json</files>
  <action>
1. Create `api/index.ts` at the project root (NOT in server/):
   ```typescript
   import { createApp } from '../server/app';
   import type { Request, Response } from 'express';

   // Reuse the same app instance across warm invocations (avoids re-registering routes)
   let appPromise: ReturnType<typeof createApp> | null = null;

   export default async function handler(req: Request, res: Response) {
     if (!appPromise) {
       appPromise = createApp();
     }
     const app = await appPromise;
     return app(req, res);
   }
   ```

   Key points:
   - The `appPromise` is module-level so the app is created once per cold start and reused across warm invocations
   - Use `ReturnType<typeof createApp>` instead of hardcoding the type
   - Do NOT import cronService, setupVite, serveStatic, or any process.exit validation
   - Do NOT call `server.listen()`

2. Update `package.json` scripts:
   - Change the `"build"` script from:
     `"vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist"`
     to:
     `"vite build && esbuild server/index.ts --platform=node --packages=external --bundle --format=esm --outdir=dist"`
     Actually — keep the build script AS-IS. The esbuild step is still needed for `npm run start` (local production mode). Vercel ignores this script entirely because vercel.json specifies its own `buildCommand: "vite build"`. So the package.json build script stays the same for local use.

   - Add a `"vercel-build"` script: `"vite build"` — this is what vercel.json's `buildCommand` will reference. Actually, vercel.json's `buildCommand` runs directly and doesn't need a script. Leave package.json build script unchanged.

   - No changes to package.json are needed after all. The build script stays as-is for local prod mode. Vercel uses its own buildCommand from vercel.json (created in Plan 02-02).

   So this sub-step is: verify the existing build script still works. Run `npm run build` to confirm the esbuild step doesn't error on the refactored server/index.ts.
  </action>
  <verify>
    1. Verify `api/index.ts` exists at project root, NOT inside server/
    2. Verify `api/index.ts` imports `createApp` from `'../server/app'`
    3. Verify `api/index.ts` exports `default` function handler
    4. Verify `api/index.ts` does NOT contain process.exit, cronService, setupVite, serveStatic, server.listen
    5. Run `npx tsc --noEmit 2>&1 | grep "api/index.ts"` — no errors in api/index.ts
    6. Run `npm run build 2>&1 | tail -10` — build completes without error
  </verify>
  <done>api/index.ts exists at project root, exports a default async handler that lazily creates and reuses the Express app. npm run build still completes for local production use.</done>
</task>

</tasks>

<verification>
1. `grep -n "process.exit" server/app.ts` — should return nothing
2. `grep -n "cronService" server/app.ts` — should return nothing
3. `grep -n "setupVite\|serveStatic" server/app.ts` — should return nothing (except maybe a comment)
4. `grep -n "online-course/webhook" server/app.ts` — should show express.raw() on this path
5. `grep -n "createApp" server/index.ts` — should show import from './app'
6. `grep -n "createApp" api/index.ts` — should show import from '../server/app'
7. `head -5 api/index.ts` — should be at project root, not in server/
8. `npm run build` completes without error
</verification>

<success_criteria>
- server/app.ts exports createApp() with all Express middleware and routes
- api/index.ts is a thin Vercel entry point at project root
- server/index.ts is local-dev-only with process.exit, Vite, cron, listen
- Stripe webhook raw body middleware path is /api/online-course/webhook (bug fixed)
- npm run build still completes
- No new TypeScript errors in the three files
</success_criteria>

<output>
After completion, create `.planning/phases/02-vercel-adapter/02-01-SUMMARY.md`
</output>
