---
phase: 02-vercel-adapter
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - vercel.json
  - .env.example
autonomous: false

user_setup:
  - service: vercel
    why: "Hosting platform for deployment"
    env_vars:
      - name: DATABASE_URL
        source: "Neon Console -> Connection Details -> Pooled connection string (must contain '-pooler' in hostname)"
      - name: SESSION_SECRET
        source: "Generate: node -e \"console.log(require('crypto').randomBytes(64).toString('hex'))\""
      - name: APP_URL
        source: "Your Vercel deployment URL (e.g., https://practicaldefense.vercel.app) — set after first deploy, then redeploy"
      - name: BLOB_READ_WRITE_TOKEN
        source: "Vercel Dashboard -> Storage -> Blob -> your store -> Tokens tab"
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_ONLINE_COURSE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> your endpoint -> Signing secret"
      - name: VITE_STRIPE_PUBLIC_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: SENDGRID_API_KEY
        source: "SendGrid Dashboard -> Settings -> API Keys"
      - name: FROM_EMAIL
        source: "Verified sender in SendGrid (e.g., noreply@yourdomain.com)"
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers (e.g., +1234567890)"
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
      - name: MOODLE_URL
        source: "Your Moodle instance URL"
      - name: MOODLE_TOKEN
        source: "Your Moodle API token"
    dashboard_config:
      - task: "Create Vercel project linked to this Git repo"
        location: "Vercel Dashboard -> Add New Project -> Import Git Repository"
      - task: "Create Vercel Blob store and link to project"
        location: "Vercel Dashboard -> Storage -> Create -> Blob"
      - task: "Set all env vars listed above in Vercel project settings"
        location: "Vercel Dashboard -> Project -> Settings -> Environment Variables"
      - task: "Run db:push to create blobAclPolicies table on production DB"
        location: "Terminal: DATABASE_URL=<pooled-url> npx drizzle-kit push"

must_haves:
  truths:
    - "vercel.json routes /api/* and /auth/* traffic to the Express serverless function"
    - "vercel.json routes /sitemap.xml and /robots.txt to the Express serverless function"
    - "vercel.json SPA fallback serves index.html for all unmatched non-API paths"
    - "Vercel build command runs only vite build (not esbuild)"
    - "Vercel output directory points to dist/public"
    - "All required env vars are set in Vercel project settings"
    - "First deployment completes without bundle size errors"
    - "The React frontend loads in a browser on the Vercel URL"
  artifacts:
    - path: "vercel.json"
      provides: "Vercel project configuration"
      contains: "rewrites"
    - path: ".env.example"
      provides: "Updated env var documentation with DATABASE_URL_DIRECT"
      contains: "DATABASE_URL_DIRECT"
  key_links:
    - from: "vercel.json"
      to: "api/index.ts"
      via: "rewrites destination"
      pattern: "/api/index.ts"
    - from: "vercel.json"
      to: "dist/public"
      via: "outputDirectory"
      pattern: "dist/public"
---

<objective>
Create vercel.json routing configuration, deploy to Vercel, and verify the deployment serves the React frontend and routes API traffic to the Express serverless function.

Purpose: This is the first actual deployment to Vercel. The app goes from local-only to live on the internet. The vercel.json file tells Vercel how to route traffic between the CDN (static React files) and the serverless function (Express API).

Output: vercel.json configuration file, updated .env.example, successful first Vercel deployment with React frontend loading.
</objective>

<execution_context>
@/Users/jeremygill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremygill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vercel-adapter/02-RESEARCH.md
@.planning/phases/02-vercel-adapter/02-01-SUMMARY.md
@vercel.json
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create vercel.json and update .env.example</name>
  <files>vercel.json, .env.example</files>
  <action>
1. Create `vercel.json` at the project root with:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "buildCommand": "vite build",
  "outputDirectory": "dist/public",
  "functions": {
    "api/index.ts": {
      "maxDuration": 30
    }
  },
  "rewrites": [
    { "source": "/api/:path*", "destination": "/api/index.ts" },
    { "source": "/auth/:path*", "destination": "/api/index.ts" },
    { "source": "/sitemap.xml", "destination": "/api/index.ts" },
    { "source": "/robots.txt", "destination": "/api/index.ts" },
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

Key decisions from research:
- `buildCommand: "vite build"` — Vercel only needs the frontend build. The api/ directory is compiled by Vercel's TypeScript runtime automatically. Do NOT use the package.json build script (which includes esbuild for local prod).
- `outputDirectory: "dist/public"` — matches vite.config.ts `build.outDir`
- `maxDuration: 30` — default 10s is too short for DB-heavy operations. 30s is safe for Hobby and Pro plans.
- `/sitemap.xml` and `/robots.txt` have explicit rewrites because they are dynamically generated by Express in routes.ts, not static files.
- SPA fallback `/(.*) -> /index.html` fires only for paths not matching a real file (Vercel applies rewrites AFTER filesystem check).
- Do NOT include deprecated fields: `version`, `builds`, `routes`.

2. Update `.env.example` to add `DATABASE_URL_DIRECT` documentation:

Add a comment and variable after the existing `DATABASE_URL` entry:

```
# For Vercel serverless: use the POOLED connection string (hostname contains '-pooler')
DATABASE_URL=postgresql://user:password@ep-xxx-pooler.us-east-2.aws.neon.tech/practicaldefense

# Direct (non-pooled) connection for Drizzle migrations only
# Required for: npx drizzle-kit push (uses SET statements incompatible with PgBouncer)
# Get from: Neon Console -> Connection Details -> Direct connection string
DATABASE_URL_DIRECT=postgresql://user:password@ep-xxx.us-east-2.aws.neon.tech/practicaldefense
```

This documents the blocker/concern from STATE.md about pooled vs. direct connections.

3. Rename the Stripe webhook env var in `.env.example`:
   - Change `STRIPE_WEBHOOK_SECRET=whsec_...` to `STRIPE_ONLINE_COURSE_WEBHOOK_SECRET=whsec_...`
   - This matches the actual env var name used in `server/routes.ts` (`process.env.STRIPE_ONLINE_COURSE_WEBHOOK_SECRET`).
  </action>
  <verify>
    1. `cat vercel.json | python3 -m json.tool` — valid JSON, no syntax errors
    2. Verify vercel.json contains `buildCommand`, `outputDirectory`, `functions`, `rewrites`
    3. Verify rewrites include /api/:path*, /auth/:path*, /sitemap.xml, /robots.txt, and SPA fallback
    4. Verify vercel.json does NOT contain `version`, `builds`, or `routes` (deprecated fields)
    5. `grep "DATABASE_URL_DIRECT" .env.example` — should show the new direct connection documentation
    6. `grep "STRIPE_ONLINE_COURSE_WEBHOOK_SECRET" .env.example` — should show the renamed env var (not STRIPE_WEBHOOK_SECRET)
  </verify>
  <done>vercel.json is created with correct routing, build command, and output directory. .env.example documents both pooled and direct database URLs, and uses the correct STRIPE_ONLINE_COURSE_WEBHOOK_SECRET env var name.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Set Vercel env vars and deploy</name>
  <what-needs-doing>
    The following must be configured before deployment works end-to-end. Claude cannot access the Vercel dashboard or external service dashboards.

    **Step 1: Vercel Project Setup**
    1. Go to Vercel Dashboard -> Add New Project
    2. Import this Git repository
    3. The framework will be auto-detected; verify it shows the correct settings

    **Step 2: Create Vercel Blob Store** (if not already done)
    1. Vercel Dashboard -> Storage -> Create -> Blob
    2. Link it to this project
    3. Copy the BLOB_READ_WRITE_TOKEN from the store's Tokens tab

    **Step 3: Set Environment Variables**
    Go to Vercel Dashboard -> Project -> Settings -> Environment Variables and add ALL of the following:

    | Variable | Source | Scope |
    |----------|--------|-------|
    | DATABASE_URL | Neon Console -> Connection Details -> **Pooled** string (hostname has `-pooler`) | Production, Preview |
    | SESSION_SECRET | Generate: `node -e "console.log(require('crypto').randomBytes(64).toString('hex'))"` | Production, Preview |
    | APP_URL | Your Vercel deployment URL (e.g., `https://practicaldefense.vercel.app`). Set after first deploy, then redeploy. | Production |
    | BLOB_READ_WRITE_TOKEN | Vercel Dashboard -> Storage -> Blob -> Tokens tab | Production, Preview |
    | STRIPE_SECRET_KEY | Stripe Dashboard -> Developers -> API keys | Production |
    | STRIPE_ONLINE_COURSE_WEBHOOK_SECRET | Stripe Dashboard -> Developers -> Webhooks -> Signing secret | Production |
    | VITE_STRIPE_PUBLIC_KEY | Stripe Dashboard -> Developers -> API keys -> Publishable key | Production, Preview |
    | SENDGRID_API_KEY | SendGrid Dashboard -> Settings -> API Keys | Production |
    | FROM_EMAIL | Your verified SendGrid sender address | Production |
    | TWILIO_ACCOUNT_SID | Twilio Console -> Account Info | Production |
    | TWILIO_AUTH_TOKEN | Twilio Console -> Account Info | Production |
    | TWILIO_PHONE_NUMBER | Twilio Console -> Phone Numbers | Production |
    | GOOGLE_CLIENT_ID | Google Cloud Console -> Credentials | Production |
    | GOOGLE_CLIENT_SECRET | Google Cloud Console -> Credentials | Production |
    | MOODLE_URL | Your Moodle instance URL | Production |
    | MOODLE_TOKEN | Your Moodle API token | Production |
    | NODE_ENV | `production` | Production |

    **Step 4: Run Database Migration**
    Run this command locally (using the DIRECT/non-pooled Neon URL):
    ```bash
    DATABASE_URL="postgresql://user:pass@ep-xxx.us-east-2.aws.neon.tech/dbname" npx drizzle-kit push
    ```
    This creates the `blobAclPolicies` table added in Phase 1.

    **Step 5: Deploy**
    Push to the main branch (or trigger deploy from Vercel dashboard).

    **Step 6: Check bundle size**
    After deploy completes, check Vercel Dashboard -> Deployments -> latest -> Function tab.
    Look at the size of `api/index.ts`. If it exceeds 250MB, report back — the fallback plan is to convert googleapis imports to dynamic imports in calendarService.ts and cronService.ts.

    **Step 7: Verify React frontend loads**
    Visit the deployment URL in a browser. The React frontend should load (login page or landing page).
    API calls may fail if env vars aren't fully configured yet — that's OK for now.
  </what-needs-doing>
  <resume-signal>Type "deployed" with the Vercel URL, OR describe any deployment errors (especially bundle size issues)</resume-signal>
</task>

</tasks>

<verification>
1. `vercel.json` exists at project root with correct routing configuration
2. Vercel deployment succeeds without bundle size errors
3. React frontend loads in browser at Vercel URL
4. Navigating to /api/* routes returns Express responses (not 404)
</verification>

<success_criteria>
- vercel.json created with correct rewrites, buildCommand, outputDirectory
- .env.example updated with DATABASE_URL_DIRECT documentation
- Vercel project is deployed and the React frontend loads
- Bundle size is within Vercel's 250MB limit (confirmed in deployment logs)
</success_criteria>

<output>
After completion, create `.planning/phases/02-vercel-adapter/02-02-SUMMARY.md`
</output>
