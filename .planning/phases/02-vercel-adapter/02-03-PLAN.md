---
phase: 02-vercel-adapter
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "A user can log in, navigate to an authenticated page, and log out — session persists across requests on the Vercel domain"
    - "A Stripe test webhook event is received, signature-validated, and processed without error on the Vercel deployment"
    - "A file upload completes and the resulting URL is accessible (end-to-end storage flow on Vercel)"
  artifacts: []
  key_links:
    - from: "Stripe Dashboard webhook endpoint"
      to: "Vercel deployment /api/online-course/webhook"
      via: "Stripe webhook delivery"
      pattern: "constructEvent"
    - from: "Browser file upload form"
      to: "Vercel deployment /api/objects/upload"
      via: "multipart/form-data POST"
      pattern: "ObjectStorageService"
---

<objective>
Verify the three critical integration points that differ between local development and Vercel serverless: session persistence across requests, Stripe webhook signature validation with correct raw body handling, and file upload through the serverless function to Vercel Blob.

Purpose: These are the three things most likely to break in the serverless transition. Sessions must survive across stateless function invocations (via DB-backed store). Stripe webhooks must receive raw body (not parsed JSON) for signature verification. File uploads must flow through the 4.5MB Vercel body limit to Vercel Blob storage.

Output: Verified working integrations — or identified fixes needed (which become gap closure plans).
</objective>

<execution_context>
@/Users/jeremygill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremygill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-vercel-adapter/02-RESEARCH.md
@.planning/phases/02-vercel-adapter/02-01-SUMMARY.md
@.planning/phases/02-vercel-adapter/02-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Verify session persistence (login/navigate/logout)</name>
  <what-built>
    Express-session with connect-pg-simple (PostgreSQL-backed session store), trust proxy 1, secure cookies in production, sameSite lax. This was NOT changed in Phase 2 — it was already configured correctly. The verification confirms it works in the Vercel serverless context where each request may hit a different function instance.
  </what-built>
  <how-to-verify>
    1. Open the Vercel deployment URL in a browser
    2. Navigate to the login page
    3. Log in with valid credentials (student or instructor account)
    4. After login: verify you see the authenticated dashboard (not redirected back to login)
    5. Navigate to 2-3 different authenticated pages (e.g., settings, courses)
    6. Each page should load with your session intact (not asked to re-login)
    7. Refresh the browser — session should persist
    8. Log out — verify you are redirected to the public page
    9. Try accessing an authenticated page directly — should redirect to login

    **What to report:**
    - "session works" if all steps pass
    - If any step fails, describe which step and what you see (e.g., "Step 5 fails — navigating to /settings redirects to login")
  </how-to-verify>
  <resume-signal>Type "session works" or describe the failure</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Stripe webhook signature validation</name>
  <what-built>
    The express.raw() middleware is now registered on /api/online-course/webhook (fixed from incorrect /api/webhooks/stripe path). This ensures req.body is a raw Buffer when the Stripe webhook handler calls stripe.webhooks.constructEvent(). The fix was made in Plan 02-01 during server/app.ts extraction.
  </what-built>
  <how-to-verify>
    **Option A: Stripe CLI (preferred)**
    1. Install Stripe CLI if not already: `brew install stripe/stripe-cli/stripe`
    2. Log in: `stripe login`
    3. Forward events to your Vercel deployment:
       ```
       stripe listen --forward-to https://YOUR-VERCEL-URL/api/online-course/webhook
       ```
    4. In another terminal, trigger a test event:
       ```
       stripe trigger payment_intent.succeeded
       ```
    5. Check the `stripe listen` output — it should show the event was delivered and received a 200 response
    6. Check Vercel function logs (Vercel Dashboard -> Deployments -> Functions tab -> Logs) for the webhook processing log

    **Option B: Stripe Dashboard**
    1. Go to Stripe Dashboard -> Developers -> Webhooks
    2. Add a new endpoint with URL: `https://YOUR-VERCEL-URL/api/online-course/webhook`
    3. Select events to listen for (at minimum: `payment_intent.succeeded`, `checkout.session.completed`)
    4. Click "Send test webhook" for `payment_intent.succeeded`
    5. Verify the response is 200 (not 400 "No signatures found...")

    **What to report:**
    - "webhook works" if signature validation passes (200 response)
    - "webhook fails" with the error message if signature validation fails (likely 400 with "No signatures found matching...")
    - If the endpoint returns 502/504, that's a function crash — report the Vercel function logs
  </how-to-verify>
  <resume-signal>Type "webhook works" or describe the error</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify file upload end-to-end on Vercel</name>
  <what-built>
    File upload flow: client POSTs multipart/form-data to /api/objects/upload, Express (via multer) receives the file, server calls @vercel/blob put() to store it, returns the blob URL. ACL policy is created in the blobAclPolicies database table. This was built in Phase 1 (Plan 01-03) and should work unchanged on Vercel.

    IMPORTANT: Vercel has a 4.5MB request body limit for serverless functions. Test with a small file (under 4MB). Large file uploads (> 4.5MB) are expected to fail and are out of scope for Phase 2.
  </what-built>
  <how-to-verify>
    1. Log in to the Vercel deployment as an instructor or admin
    2. Navigate to a course edit page (or any page with file upload)
    3. Upload a small image file (under 4MB — e.g., a course cover image)
    4. Verify the upload completes without error
    5. Verify the uploaded image displays correctly on the page
    6. Try accessing the image URL directly in a new browser tab — it should load

    **Alternative test path (if no course exists):**
    1. Log in as admin
    2. Create a new course
    3. Upload a course image during creation
    4. Verify the image appears in the course listing

    **What to report:**
    - "upload works" if the file uploads and displays correctly
    - If upload fails, report the error message (check browser dev tools Network tab for the /api/objects/upload response)
    - If the image URL doesn't load, report the URL format (it should be a vercel-blob.com URL)
  </how-to-verify>
  <resume-signal>Type "upload works" or describe the failure</resume-signal>
</task>

</tasks>

<verification>
All three integration points verified on the live Vercel deployment:
1. Session persistence: login -> navigate -> refresh -> logout cycle works
2. Stripe webhook: test event received and signature validated (200 response)
3. File upload: small file uploaded to Vercel Blob and accessible via URL
</verification>

<success_criteria>
- A user can log in, navigate authenticated pages, and log out on the Vercel domain
- Stripe test webhook event is signature-validated and returns 200
- File upload completes and the resulting URL is accessible
- All three verifications pass, confirming Phase 2 success criteria are met
</success_criteria>

<output>
After completion, create `.planning/phases/02-vercel-adapter/02-03-SUMMARY.md`
</output>
