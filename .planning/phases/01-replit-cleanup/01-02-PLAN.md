---
phase: 01-replit-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/stripeClient.ts
  - server/stripeConnect/routes.ts
  - server/index.ts
  - server/routes.ts
  - server/storage.ts
  - server/seo.ts
  - server/emailService.ts
  - server/notificationEngine.ts
  - server/services/cronService.ts
  - client/src/App.tsx
  - client/src/pages/stripe-connect.tsx
  - client/src/lib/stripe.ts
  - client/src/components/Layout.tsx

autonomous: true

must_haves:
  truths:
    - "Stripe client initializes directly from STRIPE_SECRET_KEY env var — no Replit credential fallback or database credential path exists"
    - "Server starts without error when STRIPE_SECRET_KEY is not set (logs warning, does not crash)"
    - "All URLs in emailService, notificationEngine, cronService, and routes use APP_URL — no REPLIT_DOMAINS or REPLIT_DEV_DOMAIN references remain"
    - "No /stripe-connect route or page exists in client or server"
  artifacts:
    - path: "server/stripeClient.ts"
      provides: "Simplified Stripe client with env-var-only initialization"
      exports: ["getStripeClient", "isStripeConfigured"]
    - path: "client/src/lib/stripe.ts"
      provides: "Client-side Stripe loading from VITE_STRIPE_PUBLIC_KEY env var"
  key_links:
    - from: "server/stripeClient.ts"
      to: "process.env.STRIPE_SECRET_KEY"
      via: "direct env var read"
      pattern: "process\\.env\\.STRIPE_SECRET_KEY"
    - from: "server/emailService.ts"
      to: "process.env.APP_URL"
      via: "env var replacement"
      pattern: "process\\.env\\.APP_URL"
    - from: "server/notificationEngine.ts"
      to: "process.env.APP_URL"
      via: "env var replacement"
      pattern: "process\\.env\\.APP_URL"
---

<objective>
Simplify Stripe initialization to env-var-only, remove the Stripe Connect admin key management module, and replace all REPLIT_DOMAINS/REPLIT_DEV_DOMAIN URL references with a single APP_URL env var.

Purpose: Eliminate all Replit runtime dependencies from server code — credential fetching via Replit sidecar, Replit domain references in emails/notifications/routes, and the misnamed "Stripe Connect" admin key UI. After this plan, the server uses only standard environment variables.
Output: Clean stripeClient.ts, no stripeConnect module, APP_URL used everywhere for URL construction.
</objective>

<execution_context>
@/Users/jeremygill/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jeremygill/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-replit-cleanup/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify stripeClient.ts and remove Stripe Connect module</name>
  <files>server/stripeClient.ts, server/stripeConnect/routes.ts, server/index.ts, server/routes.ts, server/storage.ts, server/seo.ts, client/src/App.tsx, client/src/pages/stripe-connect.tsx, client/src/lib/stripe.ts, client/src/components/Layout.tsx</files>
  <action>
**1. Rewrite server/stripeClient.ts** — replace the entire file with:
```typescript
import Stripe from 'stripe';

let _client: Stripe | null = null;

export function getStripeClient(): Stripe | null {
  if (!_client && process.env.STRIPE_SECRET_KEY) {
    _client = new Stripe(process.env.STRIPE_SECRET_KEY, {
      apiVersion: '2025-08-27.basil',
    });
  }
  return _client;
}

export function isStripeConfigured(): boolean {
  return !!process.env.STRIPE_SECRET_KEY;
}
```

Remove ALL of these from stripeClient.ts:
- `getCredentialsFromReplit()` function
- `getCredentialsFromDatabase()` function
- `getCredentials()` function
- `getUncachableStripeClient()` function
- `getStripePublishableKey()` function
- `getStripeSecretKey()` function
- `resetStripeClientCache()` function
- `validateStripeSecretKey()` function
- `import { storage }` and `import { decrypt, isEncryptionConfigured }`

Note: `getStripeClient()` now returns `Stripe | null` (synchronous) instead of `Promise<Stripe>`. All callers in routes.ts that do `await getStripeClient()` must be updated to remove `await` and add a null check. Search for all callers of `getStripeClient` in routes.ts and update them. Typical pattern:
```typescript
const stripe = getStripeClient();
if (!stripe) return res.status(503).json({ message: 'Payment processing not configured' });
```

Also search for callers of `getStripePublishableKey`, `getStripeSecretKey`, `getUncachableStripeClient`, `resetStripeClientCache`, and `validateStripeSecretKey` — all must be removed or replaced.

**2. Delete server/stripeConnect/routes.ts** and the server/stripeConnect/ directory entirely.

**3. Update server/routes.ts:**
- Remove line 19: `import { stripeConnectRouter } from "./stripeConnect/routes"`
- Remove line 9230: `app.use('/api/stripe-connect', stripeConnectRouter)`

**4. Update server/index.ts:**
- Remove line 12: `app.use('/api/stripe-connect/webhook', express.raw({ type: 'application/json' }))`

**5. Update server/storage.ts:**
- Remove the interface methods: `getStripeCredentials()`, `saveStripeCredentials()`, `deleteStripeCredentials()` from the IStorage interface
- Remove the implementations: `async getStripeCredentials()`, `async saveStripeCredentials()`, `async deleteStripeCredentials()` from the DatabaseStorage class
- Also remove `getUsersByStripeConnectAccountId()` from both the interface and implementation if it is only called from stripeConnect/routes.ts (check first — if used elsewhere, keep it)

**6. Update server/seo.ts:**
- Remove line 350: `Disallow: /stripe-connect`

**7. Delete client/src/pages/stripe-connect.tsx**

**8. Update client/src/App.tsx:**
- Remove the import: `import StripeConnectPage from "@/pages/stripe-connect"`
- Remove the route: `<Route path="/stripe-connect" component={StripeConnectPage} />`

**9. Update client/src/lib/stripe.ts** — replace the entire file:
```typescript
import { loadStripe, Stripe } from '@stripe/stripe-js';

let stripePromiseCache: Promise<Stripe | null> | null = null;

export function getStripePromise(): Promise<Stripe | null> | null {
  if (stripePromiseCache) {
    return stripePromiseCache;
  }

  const publishableKey = import.meta.env.VITE_STRIPE_PUBLIC_KEY;
  if (!publishableKey) {
    console.warn('[Stripe] VITE_STRIPE_PUBLIC_KEY not set — Stripe disabled on client');
    return null;
  }

  stripePromiseCache = loadStripe(publishableKey);
  return stripePromiseCache;
}
```

Note: This function is now synchronous (returns the cached promise or null) and no longer fetches from the server. The publishable key comes from the Vite env var `VITE_STRIPE_PUBLIC_KEY`. Check all callers of `getStripePromise()` — if any `await` it, they should handle the `null` case.

**10. Update client/src/components/Layout.tsx:**
- Remove all three `<Link href="/stripe-connect" ...>` references (lines 157, 661, 1020 approximately)
- Replace with links to a settings page or remove the nav items entirely. Since the Stripe Connect admin UI is being removed, these nav links should be removed. If the surrounding menu structure would look broken without them, remove the entire menu item (li or div wrapper).
  </action>
  <verify>
Run these checks:
1. `grep -r "stripeConnect\|stripe-connect\|getCredentialsFromReplit\|getCredentialsFromDatabase\|REPLIT_CONNECTORS\|REPL_IDENTITY\|WEB_REPL_RENEWAL\|REPLIT_DEPLOYMENT" server/ client/` — should return no matches (except possibly in .planning/ docs)
2. `npm run check` — TypeScript compilation passes
3. Verify `server/stripeConnect/` directory no longer exists
4. Verify `client/src/pages/stripe-connect.tsx` no longer exists
  </verify>
  <done>stripeClient.ts uses env-var only. Stripe Connect module fully removed from server and client. All callers updated. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Replace all REPLIT_DOMAINS and REPLIT_DEV_DOMAIN references with APP_URL</name>
  <files>server/emailService.ts, server/notificationEngine.ts, server/services/cronService.ts, server/routes.ts</files>
  <action>
Replace all 8 REPLIT env var references with `process.env.APP_URL`. The APP_URL env var will be validated at startup (Plan 03 adds the startup validation).

**1. server/emailService.ts (lines 245-246):**
Replace:
```typescript
const APP_URL = process.env.REPLIT_DEV_DOMAIN
  ? `https://${process.env.REPLIT_DEV_DOMAIN}`
  : 'http://localhost:5000';
```
With:
```typescript
const APP_URL = process.env.APP_URL || 'http://localhost:5000';
```

**2. server/notificationEngine.ts** — 5 locations:
- Line 106: Replace `process.env.REPLIT_DOMAINS?.split(',')[0] || 'https://abqconcealedcarry.com'` with `process.env.APP_URL || 'https://abqconcealedcarry.com'`
- Line 933: Replace `process.env.REPLIT_DOMAINS || 'https://abqconcealedcarry.com'` with `process.env.APP_URL || 'https://abqconcealedcarry.com'`
- Line 1360: Replace `process.env.REPLIT_DOMAINS?.split(',')[0] || 'https://example.com'` with `process.env.APP_URL || 'https://example.com'`
- Line 1400: Replace `process.env.REPLIT_DOMAINS?.split(',')[0] || 'https://example.com'` with `process.env.APP_URL || 'https://example.com'`
- Line 1420: Replace `process.env.REPLIT_DOMAINS?.split(',')[0] || 'tacticaladv.com'` with `process.env.APP_URL || 'https://practicaldefense.com'`

**3. server/services/cronService.ts (line 8):**
Replace:
```typescript
const WEBHOOK_CALLBACK_URL = process.env.WEBHOOK_CALLBACK_URL || `${process.env.REPLIT_DEV_DOMAIN ? `https://${process.env.REPLIT_DEV_DOMAIN}` : 'http://localhost:5000'}/api/availability/webhook/calendar`;
```
With:
```typescript
const WEBHOOK_CALLBACK_URL = process.env.WEBHOOK_CALLBACK_URL || `${process.env.APP_URL || 'http://localhost:5000'}/api/availability/webhook/calendar`;
```

**4. server/routes.ts (lines 6478-6479):**
Replace:
```typescript
const baseUrl = process.env.REPLIT_DOMAINS?.split(',')[0] || 'https://example.com';
```
With:
```typescript
const baseUrl = process.env.APP_URL || 'https://example.com';
```
Also remove the comment on line 6478 about REPLIT_DOMAINS.

**After all replacements**, verify no REPLIT references remain:
```bash
grep -rn "REPLIT_DOMAINS\|REPLIT_DEV_DOMAIN\|REPLIT_DEPLOYMENT\|REPL_IDENTITY\|REPLIT_CONNECTORS\|REPL_ID" server/ --include="*.ts" | grep -v "replitAuth.ts.backup" | grep -v ".planning/"
```
This should return zero results (replitAuth.ts.backup is deleted in Plan 01, and the sidecar reference in objectStorage.ts is handled in Plan 03).

Note: `server/objectStorage.ts` still has `REPLIT_SIDECAR_ENDPOINT` and `server/routes.ts` line 8937 has `REPLIT_SIDECAR_ENDPOINT` — these are GCS sidecar references handled in Plan 03 (Vercel Blob migration). Do NOT touch them in this plan.
  </action>
  <verify>
Run:
1. `grep -rn "REPLIT_DOMAINS\|REPLIT_DEV_DOMAIN\|REPLIT_DEPLOYMENT\|REPL_IDENTITY\|REPLIT_CONNECTORS\|REPL_ID" server/ --include="*.ts" | grep -v objectStorage | grep -v "routes.ts:8937"` — should return no matches (remaining sidecar refs are Plan 03)
2. `grep -rn "APP_URL" server/emailService.ts server/notificationEngine.ts server/services/cronService.ts server/routes.ts` — should show APP_URL used in all 8 locations
3. `npm run check` — TypeScript compilation passes
  </verify>
  <done>All 8 REPLIT_DOMAINS/REPLIT_DEV_DOMAIN references replaced with APP_URL. No REPLIT env var references remain in server code except the GCS sidecar references (Plan 03 scope). TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. `npm run check` passes — no TypeScript errors
2. `grep -rn "REPLIT_DOMAINS\|REPLIT_DEV_DOMAIN\|REPLIT_DEPLOYMENT\|REPL_IDENTITY\|REPLIT_CONNECTORS\|REPL_ID\|getCredentialsFromReplit\|getCredentialsFromDatabase\|stripeConnect\|stripe-connect" server/ client/src/ --include="*.ts" --include="*.tsx" | grep -v objectStorage | grep -v "routes.ts:8937"` — returns no matches
3. `server/stripeConnect/` directory does not exist
4. `client/src/pages/stripe-connect.tsx` does not exist
5. stripeClient.ts exports only `getStripeClient` and `isStripeConfigured`
6. emailService.ts, notificationEngine.ts, cronService.ts, routes.ts all use `process.env.APP_URL`
</verification>

<success_criteria>
Stripe initializes from STRIPE_SECRET_KEY only (no Replit/database fallback). All URL construction uses APP_URL. The Stripe Connect admin module is completely removed from server and client. Server starts without error when STRIPE_SECRET_KEY is absent (graceful degradation). TypeScript compiles cleanly.
</success_criteria>

<output>
After completion, create `.planning/phases/01-replit-cleanup/01-02-SUMMARY.md`
</output>
